# Диаграмма потока данных Idea-to-Post Pipeline

**Тип документа:** Визуальная справка
**Дата:** 30 января 2026
**Версия:** 1.0
**Статус:** Полная документация

---

## Обзор

Документирует полный поток данных через Content Machine Pipeline.

---

## 1. Путь обычного контента (3 шага)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ОБЫЧНЫЙ ПУТЬ КОНТЕНТА                               │
│                          (3 шага)                                       │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ ШАГИ 1-2: Выбор и исследование                                          │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Step c-01: Добавить идею         Step c-02: Исследовать               │
│  ─────────────────────────────    ──────────────────────────            │
│                                                                          │
│  idea_inbox.csv                   ideas_research.csv                     │
│  ├─ id                            ├─ id                                 │
│  ├─ raw_idea ──────────────┐      ├─ original_idea_id ← ┐              │
│  ├─ category               │      ├─ research_date                      │
│  └─ date_added             │      ├─ main_angle                        │
│                            └────► ├─ pain_points_json ⭐ NEW            │
│                                   ├─ angles_list                       │
│                                   └─ best_angle_id                     │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

         │
         │
         ▼

┌──────────────────────────────────────────────────────────────────────────┐
│ ШАГ 3: Выбор идеи для публикации и создание черновика                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Step c-03: CREATE mode (5 подшагов)                                   │
│  ──────────────────────────────────────────                            │
│                                                                          │
│  Входные данные (из c-02):                                              │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ ideas_research.csv (выбранная строка)              │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ id=1, pain_points_json={...}, angle_1, ...        │                 │
│  └────────────────────────────────────────────────────┘                 │
│            │                                                             │
│            │ c-03b1: Выбор идеи и угла                                 │
│            ▼                                                             │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ workflow_state.json (создается)                    │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ {                                                  │                 │
│  │   session_id: "session-2026-01-30-15-32-45",     │                 │
│  │   selected_idea_id: 1,                            │                 │
│  │   selected_angle: "angle_1",                      │                 │
│  │   ...                                             │                 │
│  │ }                                                 │                 │
│  └────────────────────────────────────────────────────┘                 │
│            │                                                             │
│            │ c-03b2: Генерация предложений                              │
│            │ (использует: pain_points_json + offer_filter.csv)          │
│            ▼                                                             │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ workflow_state.json (обновляется)                  │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ {                                                  │                 │
│  │   generated_offers: [                            │                 │
│  │     { id: "offer-1", type: "training", ... },   │                 │
│  │     { id: "offer-2", type: "templates", ... }   │                 │
│  │   ]                                              │                 │
│  │ }                                                 │                 │
│  └────────────────────────────────────────────────────┘                 │
│            │                                                             │
│            │ c-03c: Создание черновиков                                 │
│            │ (читает: generated_offers из JSON)                          │
│            ▼                                                             │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ workflow_state.json (обновляется)                  │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ {                                                  │                 │
│  │   draft_variants: [                              │                 │
│  │     { variant_id: "draft-1", title: "...", ... }, │                 │
│  │     { variant_id: "draft-2", title: "...", ... }  │                 │
│  │   ]                                              │                 │
│  │ }                                                 │                 │
│  └────────────────────────────────────────────────────┘                 │
│            │                                                             │
│            │ c-03d: Улучшения вариантов (опционально)                  │
│            ▼                                                             │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ workflow_state.json (обновляется)                  │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ {                                                  │                 │
│  │   draft_variants[i].improvements_applied: [...]  │                 │
│  │ }                                                 │                 │
│  └────────────────────────────────────────────────────┘                 │
│            │                                                             │
│            │ c-03e: Финализация и сохранение                            │
│            │ (читает: selected draft_variant из JSON)                    │
│            ▼                                                             │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ posts_content.csv (добавляется новая строка)       │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ id=1, title="...", body="...",                    │                 │
│  │ variant_of=NULL, content_type="demo", ...        │                 │
│  └────────────────────────────────────────────────────┘                 │
│            │                                                             │
│            │ Удалить workflow_state.json                                │
│            ▼                                                             │
│  ✅ ГОТОВО - контент в posts_content.csv                               │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Путь демонстрационного контента (5 шагов)

```
┌─────────────────────────────────────────────────────────────────────────┐
│               ДЕМОНСТРАЦИОННЫЙ ПУТЬ КОНТЕНТА                            │
│          (5 шагов с дополнительной генерацией вариантов)               │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ ШАГ 1-2: Выбор и исследование (как в обычном пути)                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ideas_research.csv                                                     │
│  └─ pain_points_json: {                                                │
│       "angle_1": ["Медленная документация...", ...],                  │
│       "angle_2": ["Качество зависит...", ...]                        │
│     }                                                                   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
         │
         │
         ▼

┌──────────────────────────────────────────────────────────────────────────┐
│ ШАГ 3: Генерация предложений (DEMO РАСШИРЕНИЕ)                           │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  c-03b2 с демо-режимом                                                 │
│  ─────────────────────────────                                         │
│                                                                          │
│  Входные данные:                                                        │
│  ┌─ pain_points_json (5+ точек боли по углам)                         │
│  ├─ offer_filter.csv (готов к training, setup, templates)            │
│  └─ Демо-флаг: content_type = "demo"                                  │
│                                                                          │
│  Процесс генерации:                                                    │
│  1. Читать pain_points_json из ideas_research.csv                     │
│  2. Для каждого типа предложения из offer_filter.csv:                │
│     - Сопоставить с pain_points                                      │
│     - Сгенерировать 2-3 варианта предложения                         │
│  3. Сохранить ВСЕ варианты в workflow_state.json                     │
│                                                                          │
│  Выходные данные:                                                       │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ workflow_state.json                                │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ generated_offers: [                               │                 │
│  │   { id: "offer-1", type: "training", ... },      │                 │
│  │   { id: "offer-2", type: "training", ... },      │                 │
│  │   { id: "offer-3", type: "setup", ... },         │                 │
│  │   { id: "offer-4", type: "templates", ... },     │                 │
│  │   { id: "offer-5", type: "templates", ... }      │                 │
│  │ ]                                                 │                 │
│  └────────────────────────────────────────────────────┘                 │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
         │
         │
         ▼

┌──────────────────────────────────────────────────────────────────────────┐
│ ШАГ 4: Генерация вариантов черновиков (DEMO РАСШИРЕНИЕ)                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  c-03c с демо-режимом                                                  │
│  ──────────────────────                                                │
│                                                                          │
│  Входные данные:                                                        │
│  ┌─ generated_offers (5+ предложений)                                  │
│  ├─ selected_idea (идея и угол)                                       │
│  └─ Демо-флаг: content_type = "demo"                                  │
│                                                                          │
│  Процесс генерации:                                                    │
│  1. Для каждого предложения:                                          │
│     - Сгенерировать 2-3 варианта черновика с разными hooks/angles │
│  2. Для каждого подвыглядга идеи:                                    │
│     - Сгенерировать вариант, ориентированный на этот угол          │
│  3. Сохранить ВСЕ варианты в workflow_state.json                    │
│                                                                          │
│  Выходные данные:                                                       │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ workflow_state.json                                │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ draft_variants: [                                 │                 │
│  │   { variant_id: "draft-1", hook: "80+ docs?", ... }, │                 │
│  │   { variant_id: "draft-2", hook: "2 часа...", ... }, │                 │
│  │   { variant_id: "draft-3", hook: "Качество...", ... }, │                 │
│  │   { variant_id: "draft-4", hook: "BMAD", ... },    │                 │
│  │   { variant_id: "draft-5", hook: "Workshop", ... } │                 │
│  │ ]                                                 │                 │
│  │ (более 5 вариантов)                              │                 │
│  └────────────────────────────────────────────────────┘                 │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
         │
         │
         ▼

┌──────────────────────────────────────────────────────────────────────────┐
│ ШАГ 5: Выбор лучшего варианта и финализация                              │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  c-03e (финальный выбор)                                               │
│  ──────────────────────────                                            │
│                                                                          │
│  Пользователь:                                                          │
│  1. Просматривает все draft_variants                                  │
│  2. Выбирает лучший (selected: true)                                 │
│  3. Система сохраняет в posts_content.csv                            │
│                                                                          │
│  Результат:                                                             │
│  ┌────────────────────────────────────────────────────┐                 │
│  │ posts_content.csv (новая строка)                   │                 │
│  ├────────────────────────────────────────────────────┤                 │
│  │ id=1                                               │                 │
│  │ title="Быстрая документация с BMAD"               │                 │
│  │ body="Вчера за 2 часа сгенерировал..."           │                 │
│  │ hook="80+ документов за 2 часа?"                 │                 │
│  │ variant_of=NULL                                   │                 │
│  │ content_type="demo"                              │                 │
│  │ quality_score=0.92                               │                 │
│  └────────────────────────────────────────────────────┘                 │
│                                                                          │
│  ✅ ГОТОВО - демо контент сохранен                                     │
│  ✅ Удален workflow_state.json                                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Точки сохранения состояния

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ТОЧКИ СОХРАНЕНИЯ СОСТОЯНИЯ                          │
│                   (где сохраняются данные)                             │
└─────────────────────────────────────────────────────────────────────────┘

1. ИДЕИ И ИССЛЕДОВАНИЕ
   ─────────────────────
   ┌──────────────────────────────────────────────────────────┐
   │ CSV ФАЙЛЫ (ПОСТОЯННОЕ ХРАНИЛИЩЕ)                        │
   ├──────────────────────────────────────────────────────────┤
   │ idea_inbox.csv              │  Исходные идеи            │
   │ ideas_research.csv          │  Результаты исследования  │
   │ angles_library.csv          │  Углы для идей           │
   │ posts_content.csv           │  Финальный контент       │
   │ user_preferences/           │                          │
   │   offer_filter.csv          │  Фильтр предложений      │
   └──────────────────────────────────────────────────────────┘

2. ПРОЦЕСС СОЗДАНИЯ КОНТЕНТА
   ────────────────────────────
   ┌──────────────────────────────────────────────────────────┐
   │ JSON ФАЙЛЫ (ВРЕМЕННОЕ ХРАНИЛИЩЕ)                        │
   ├──────────────────────────────────────────────────────────┤
   │ .bmad/workflow_state.json   │  Во время c-03b2 → c-03e  │
   │ (создается → обновляется → удаляется)                  │
   └──────────────────────────────────────────────────────────┘

3. АРХИВ И ВЕРСИОНИРОВАНИЕ
   ────────────────────────────
   ┌──────────────────────────────────────────────────────────┐
   │ АРХИВНЫЕ ФАЙЛЫ (ССЫЛКИ)                                 │
   ├──────────────────────────────────────────────────────────┤
   │ posts_content.variant_of    │  Ссылка на исходный пост  │
   │ posts_content.repost_count  │  Отслеживание переповтора │
   │ posts_content.last_posted   │  История публикаций       │
   └──────────────────────────────────────────────────────────┘
```

---

## 4. Интеграционные точки между шагами

```
┌─────────────────────────────────────────────────────────────────────────┐
│              ИНТЕГРАЦИОННЫЕ ТОЧКИ МЕЖДУ ШАГАМИ                          │
│                    (что передается между шагами)                        │
└─────────────────────────────────────────────────────────────────────────┘

c-01 (Добавить идею) → c-02 (Исследовать)
─────────────────────────────────────────
    Входящие данные:
    ├─ idea_id (из идеи входящей коробки)
    └─ raw_idea

    Выходные данные:
    ├─ ideas_research.csv (новая строка)
    ├─ pain_points_json (заполнен)
    └─ best_angle_id (выбран)


c-02 (Исследовать) → c-03b1 (Выбор идеи)
─────────────────────────────────────────
    Входящие данные:
    ├─ research_id (выбранная исследованная идея)
    ├─ pain_points_json
    ├─ angles_list
    └─ best_angle_id

    Выходные данные:
    ├─ workflow_state.json (создан)
    └─ selected_idea_id, selected_angle


c-03b1 (Выбор) → c-03b2 (Генерация предложений)
─────────────────────────────────────────────
    Входящие данные:
    ├─ workflow_state.json (текущее)
    ├─ pain_points_json (из ideas_research.csv)
    └─ offer_filter.csv (пользовательские предпочтения)

    Выходные данные:
    ├─ workflow_state.json (с generated_offers)
    └─ generated_offers[] (массив предложений)


c-03b2 (Предложения) → c-03c (Черновики)
──────────────────────────────────────
    Входящие данные:
    ├─ workflow_state.json (с generated_offers)
    └─ selected_idea, selected_angle

    Выходные данные:
    ├─ workflow_state.json (с draft_variants)
    └─ draft_variants[] (массив черновиков)


c-03c (Черновики) → c-03d (Улучшения)
──────────────────────────────────────
    Входящие данные:
    ├─ workflow_state.json (с draft_variants)
    └─ draft_variants (для улучшения)

    Выходные данные:
    ├─ workflow_state.json (с improvements_applied)
    └─ draft_variants (обновлен)


c-03d (Улучшения) → c-03e (Финализация)
───────────────────────────────────────
    Входящие данные:
    ├─ workflow_state.json (с draft_variants)
    └─ selected draft_variant (selected: true)

    Выходные данные:
    ├─ posts_content.csv (новая строка)
    ├─ Удален workflow_state.json
    └─ ✅ Контент готов к публикации
```

---

## 5. Зависимости данных

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ГРАФ ЗАВИСИМОСТЕЙ                              │
│                    (что зависит от чего)                               │
└─────────────────────────────────────────────────────────────────────────┘

                          ideas_inbox.csv
                                 │
                    ┌────────────┼────────────┐
                    │                        │
                    ▼                        ▼
           ideas_research.csv    angles_library.csv
                    │
      ┌─────────────┼─────────────┐
      │             │             │
      │        pain_points_json   │
      │             │             │
      ▼             ▼             ▼
    c-03b1    c-03b2 ◄─────── offer_filter.csv
      │             │
      │       generated_offers
      │             │
      ▼             ▼
   workflow_state.json (СОЗДАН И ОБНОВЛЯЕТСЯ)
      │
      ├─────────────────┬──────────────────┐
      │                 │                  │
      ▼                 ▼                  ▼
    c-03c            c-03d             c-03e
      │                 │                  │
   draft_variants    improvements       selected
      │                 │                  │
      │                 ▼                  │
      │          draft_variants (улучшен) │
      │                 │                  │
      └─────────────────┴──────────────────┘
                       │
                       ▼
                posts_content.csv
                       │
          ┌────────────┼────────────┐
          │            │            │
          ▼            ▼            ▼
       variant_of  content_type  repost_count
                       │
                  Архив и версионирование


УДАЛЕНИЕ:
─────────
workflow_state.json ──→ (удаляется после c-03e)
```

---

## 6. Проверочный список целостности потока

```
✅ Входящие данные (c-01, c-02)
   ├─ Все идеи в ideas_inbox.csv имеют уникальные id
   ├─ Все исследования в ideas_research.csv ссылаются на валидные idea_id
   ├─ pain_points_json содержит валидный JSON
   └─ angles_list соответствует best_angle_id

✅ Процесс (c-03b1 → c-03e)
   ├─ workflow_state.json создается в c-03b2
   ├─ generated_offers содержит валидный JSON
   ├─ draft_variants содержат все требуемые поля
   ├─ selected draft_variant сохраняется в posts_content.csv
   └─ workflow_state.json удаляется после c-03e

✅ Выходные данные (posts_content.csv)
   ├─ Каждый пост имеет уникальный id
   ├─ research_id ссылается на валидный research
   ├─ variant_of ссылается на валидный пост (если указано)
   ├─ quality_score между 0.0 и 1.0
   └─ content_type одно из: demo, evergreen, topical, tutorial

✅ Архив и версионирование
   ├─ variant_of сохраняет иерархию вариантов
   ├─ repost_count отслеживает переопубликации
   └─ last_posted_date обновляется при публикации
```

---

## 7. Примеры потоков данных

### Пример 1: Простой контент (3 шага)

```
ИДЕЯ: "Нужна быстрая генерация документов"
│
├─→ c-01: Добавить в ideas_inbox.csv (id=1)
│
├─→ c-02: Исследовать
│   ├─ Создать ideas_research.csv (id=1, research_id=1)
│   ├─ Добавить pain_points_json (5 болей по 2 углам)
│   └─ Определить best_angle_id = "angle_1"
│
├─→ c-03: CREATE mode
│   ├─ c-03b1: Выбрать идею id=1, angle="angle_1"
│   │   └─ Создать workflow_state.json
│   │
│   ├─ c-03b2: Генерировать предложения
│   │   ├─ Читать pain_points_json
│   │   ├─ Фильтровать по offer_filter.csv
│   │   └─ Добавить generated_offers в workflow_state.json
│   │
│   ├─ c-03c: Создать черновики
│   │   ├─ Для каждого generated_offer создать 1 вариант
│   │   └─ Добавить draft_variants в workflow_state.json
│   │
│   ├─ c-03d: (пропустить - опционально)
│   │
│   └─ c-03e: Финализировать
│       ├─ Выбрать draft-1 (selected: true)
│       ├─ Сохранить в posts_content.csv
│       └─ Удалить workflow_state.json

РЕЗУЛЬТАТ: posts_content.csv с новым постом (id=1)
```

### Пример 2: Демо контент (5 шагов)

```
ИДЕЯ: "BMAD документация" (content_type="demo")
│
├─→ c-01, c-02: Как пример 1
│
├─→ c-03: CREATE mode (демо режим)
│   ├─ c-03b1: Выбрать идею, content_type="demo"
│   │   └─ Создать workflow_state.json
│   │
│   ├─ c-03b2 (DEMO MODE): Генерировать ВСЕ возможные предложения
│   │   ├─ 2-3 для training
│   │   ├─ 2-3 для setup
│   │   ├─ 2-3 для templates
│   │   ├─ Отфильтровать по offer_filter.csv
│   │   └─ Сохранить 5+ generated_offers
│   │
│   ├─ c-03c (DEMO MODE): Генерировать ВСЕ варианты черновиков
│   │   ├─ Для каждого предложения: 2-3 варианта
│   │   ├─ Для каждого угла: 1 вариант
│   │   └─ Сохранить 6+ draft_variants
│   │
│   ├─ c-03d (DEMO MODE): Улучшить варианты
│   │   ├─ Добавить improvements_applied к каждому
│   │   └─ Рассчитать качество для каждого
│   │
│   └─ c-03e: Выбрать лучший вариант
│       ├─ Выбрать вариант с лучшей качественной оценкой
│       ├─ Сохранить в posts_content.csv
│       └─ Удалить workflow_state.json

РЕЗУЛЬТАТ: posts_content.csv с полировачным постом (content_type="demo")
```

---

## 8. Устранение неполадок потока данных

### Проблема: workflow_state.json не создается в c-03b2

```
1. Проверить: Создана ли директория .bmad?
   mkdir -p .bmad

2. Проверить: Есть ли права на запись?
   chmod 755 .bmad

3. Проверить: Содержит ли код создание JSON?
   if os.path.exists('.bmad'):
       with open('.bmad/workflow_state.json', 'w') as f:
           json.dump(state, f)

4. Проверить: Валиден ли JSON?
   json.loads(json.dumps(state))  # Должна работать
```

### Проблема: pain_points_json не заполняется в c-02

```
1. Проверить: Содержит ли ideas_research.csv столбец pain_points_json?
   head -1 data/ideas_research.csv | grep pain_points_json

2. Проверить: Заполняется ли столбец в c-02c?
   # Код должен:
   # 1. Читать идею и угол
   # 2. Генерировать точки боли для каждого угла
   # 3. Сохранять в pain_points_json (валидный JSON)

3. Проверить: Валиден ли JSON?
   json.loads(row['pain_points_json'])  # Должна работать без ошибок
```

### Проблема: draft_variants не сохраняются в posts_content.csv

```
1. Проверить: Имеет ли posts_content.csv новые столбцы?
   head -1 data/posts_content.csv | tr ',' '\n' | grep variant_of

2. Проверить: Сохраняется ли выбранный вариант в c-03e?
   # Код должен:
   # 1. Найти draft_variant с selected: true
   # 2. Скопировать title, body, cta, hook в posts_content.csv
   # 3. Установить variant_of и content_type
   # 4. Удалить workflow_state.json

3. Проверить: Есть ли данные в posts_content.csv?
   tail -1 data/posts_content.csv | cut -d',' -f1,2,3,4
```

---

**Документация завершена**
**Дата:** 30 января 2026
**Статус:** ✅ Полная диаграмма потока данных
